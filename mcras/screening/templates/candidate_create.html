{% extends "base.html" %}
{% block content %}
<div class="bg-white shadow rounded p-6">
  <h2 class="text-lg font-semibold mb-4">Candidate Apply</h2>

  <form id="cand-form" class="space-y-4" enctype="multipart/form-data">
    <div>
      <label class="block text-sm">First name</label>
      <input id="first_name" type="text" class="mt-1 block w-full rounded border-gray-300" />
    </div>
    <div>
      <label class="block text-sm">Last name</label>
      <input id="last_name" type="text" class="mt-1 block w-full rounded border-gray-300" />
    </div>
    <div>
      <label class="block text-sm">Email</label>
      <input id="email" type="email" class="mt-1 block w-full rounded border-gray-300" />
    </div>
    <div>
      <label class="block text-sm">Resume (PDF/DOCX)</label>
      <input id="resume" type="file" accept=".pdf,.docx" class="mt-1 block w-full" />
    </div>
    <div>
      <label class="block text-sm">Video (optional, mp4)</label>
      <input id="video" type="file" accept="video/*" class="mt-1 block w-full" />
    </div>
    <div>
      <label class="block text-sm">Apply to Job ID</label>
      <input id="applied_to" type="number" class="mt-1 block w-full rounded border-gray-300" placeholder="Enter JD id" required />
    </div>

    <div class="flex gap-2 items-center">
      <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded">Apply</button>
      <div id="cand-msg" class="text-sm text-green-600"></div>
    </div>
  </form>
</div>

<script>
document.getElementById('cand-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = new FormData();
  form.append('first_name', document.getElementById('first_name').value);
  form.append('last_name', document.getElementById('last_name').value);
  form.append('email', document.getElementById('email').value);
  form.append('applied_to', document.getElementById('applied_to').value);
  const resumeEl = document.getElementById('resume');
  if (resumeEl.files.length) form.append('resume', resumeEl.files[0]);
  const videoEl = document.getElementById('video');
  if (videoEl.files.length) form.append('video', videoEl.files[0]);

  const csrftoken = getCookie('csrftoken');
  const res = await fetch('/api/candidates/create/', {  // <-- trailing slash
    method: 'POST',
    headers: {'X-CSRFToken': csrftoken},
    body: form
});
  if (res.ok) {
    const data = await res.json();
    document.getElementById('cand-msg').innerText = 'Applied â€” score: ' + (data.score ?? 'processing');
  } else {
    const text = await res.text();
    document.getElementById('cand-msg').innerText = 'Error: ' + text;
  }
});

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
          }
      }
  }
  return cookieValue;
}
</script>
{% endblock %}
